BARseq/MAPseq Methods AnimalsAll animal and surgical procedures were carried out in accordance with the Institutional Animal Care and Use Committee at Allen Institute for Neural Dynamics. 8-week-old C57BL/6J animals purchased from Jackson Laboratory were acclimated to Allen Institute facility for at least one week prior to surgery. Animals were socially housed on a 12-h on/12-h off light cycle with ad libitum access to standard chow and water. The temperature in the facility was kept at 22 °C and humidity was maintained at 45–55%. Barcoded Sindbis viral libraryThe sindbis virus barcode library HZ120 (Yuan et al. 2024) was generated by the MAPseq core facility at Cold Spring Harbor Laboratory and used for MAPseq and BARseq experiments as described previously (Chen et al. 2019). The HZ120 library exhibits a diversity of ~8 million barcodes and was not fully sequenced in vitro. Viral labelling of Locus Coeruleus Noradrenergic neuronsMice were anesthetized using oxygenated 4% isoflurane and maintained with oxygenated 0.7–1.0% isoflurane throughout the surgery. Animals were mounted in a stereotaxic frame (David Kopf Instruments), and small craniotomies were performed in the skull above the Locus Coeruleus. We injected a total of 300 nL HZ120 Sindbis virus in each hemisphere at AP -5.2; ML 0.85; DV -3.20, -2.90 using NanoInject III pressure injection (SOP AF0111). Mice were allowed to recover and euthanized 22–28 h post-injection.Tissue harvest and processingAnimals were euthanized with isoflurane overdose. Brains were dissected fresh (SOP AF0061), embedded in OCT and snap-frozen in ethanol dry-ice bath. Extruded spinal cords were flash frozen straightened out on a razor blade secured in a conical tube. Samples were stored at -80C until cryosectioning.The brains were cryosectioned on Leica 3050S cryostat from the anterior to posterior end in coronal plane (SOP PF0350).  We cut 300 um slices for regions outside LC ROI (MAPseq) and 20 um for tissue containing LC ROI (BARseq). To avoid cross-contamination, we used a fresh unused part of a blade to cut each slice and cleaned the brush and the holding platform with 100% ethanol between slices. Cryostat chamber temperature was allowed to equilibrate for 30 mins to account for temperature changes between cutting thick and thin slices. For MAPseq experiment, 3 x 300 um coronal sections were mounted in a row onto Superfrost Plus Gold slides. For BARseq experiment, 4 x 20 um sections were mounted onto Superfrost Plus Gold slides according to microfluidic chamber template. Once all cut section were melted onto the slide, slides were rapidly frozen on dry ice and stored at -80 C in slide boxes in vacuum sealed bags until microdissection (MAPseq) or library prep (BARseq).MAPseq ROI microdissectionRegions of interest were hand-dissected from each brain slice under dissection scope by microscalpels pre-chilled on ice (Fine Science Tools #10316-14). Glass slides were kept on dry ice and placed on a pre-chilled metal platform mounted above dry ice – ethanol bath one at a time. Reference image was captured for each of the 3 sections from the same slide, after which microdissection began. Sections were first bisected down the midline. Then major anatomical regions were cut along their respective boundaries. Each cut was performed with a cleaned blade. Blades were rinsed in consecutive 4 x 50 ml conical tubes containing ethanol stored on ice. To keep blade temperature consistently low, 3-4 scalpels were rotated and stored on the metal platform. After right hemisphere dissection was completed, reference image for dissection boundaries was taken again for each of the 3 sections. After that, left side was dissected along the same boundaries. Individual tissue pieces were then collected into pre-chilled Qiagen microtubes (#19560 tubes, # 19566 caps) on dry ice, capped and stored at -80C. Samples for left and right hemisphere were kept separate, and corresponding ROIs were combined across 3 consecutive 300 um sections mounted on the same slide. To assess cross-sample contamination, we collected as negative controls tissue from uninjected brains.After all ROIs were collected, with samples kept on dry ice we added pre-chilled Quagen bead (#69989) to each tube. Then, spinal cord samples received 800 ul Trizol, while the rest got 400 ul Trizol (Thermofisher #15596026). Then samples were shipped overnight on dry ice to CSHL MAPseq facility. Sequencing library preparation for MAPseqRNA extraction and sequencing library preparation were performed following the protocol (dx.doi.org/10.17504/protocols.io.bsm9nc96), as described previously (Chen et al. 2019; Han et al. 2018; Huang et al. 2020; Kebschull et al. 2016). Briefly, total RNA for each region was extracted using Trizol (Thermo Fisher Scientific, 15596018) and eluted in 13ul of H2O. Before library preparation, a few randomly selected samples were run on Bioanalyzer (Agilent, 5067-1513) to ensure good RNA quality. To prepare the library for sequencing, we mixed 4 ul total RNA of each sample with 1 ul spike-in RNA (GTC ATG ATC ATA ATA CGA CTC ACT ATA GGG GAC GAG CTG TAC AAG TAA ACG CGT AAT GAT ACG GCG ACC ACC GAG ATC TAC ACT CTT TCC CTA CAC GAC GCT CTT CCG ATC TNN NNN NNN NNN NNN NNN NNN NNN NAT CAG TCA TCG GAG CGG CCG CTA CCT AAT TGC CGT CGT GAG GTA CGA CCA CCG CTA GCT GTA CA, where ATCAGTCA is the barcode tag of the spike-in. Spike-in RNA was transcribed in vitro by T7 RNA polymerase and diluted into1x104 molecules/ul), and reverse-transcribed the barcode mRNA into the first-strand cDNA using gene-specific barcoded reverse transcription primers and SuperScript IV (Thermo Fisher Scientific, 18090010). The barcoded reverse transcription primer has sequence 5’-CTT GGC ACC CGA GAA TTC CAX XXX XXX XXX XXZ ZZZ ZZZ ZTG TAC AGC TAG CGG TGG TCG-3’, where X12 are the barcoded unique molecular identifiers (UMI) and Z8 are barcoded sample specific identifiers (SSI). The synthesized first strand cDNA of each sample was labeled with a 12-nt UMI (unique for each RNA molecule) and 8-nt SSI (unique for each sample). After synthesis of the first strand cDNA, every 7-8 samples of target brain regions were pooled together for clean-up by 1.8 x AMPure XP beads (Beckman Coulter, A63881) and synthesis of the second strand cDNA (Thermo Fisher, A48571). The double-stranded cDNA samples were cleaned up by 1.8 x AMPure XP beads and treated with Exonuclease I (New England Biolabs, M0293S) to remove the single-stranded reverse transcription primers before PCR amplification.The double-stranded cDNA samples were amplified by two rounds of PCR reactions using standard Accuprime Pfx protocol (Thermo Fisher Scientific, 12344032) with 2 min extension for each cycle. Primers 5’-CTG TAC AAG TAA ACG CGT AAT G-3’ and 5’-CAAG CAGAAGACGGCATACGAGATCGTGATGTGACTGGAGTTCCTTGGCACCCGAGAATTCCA-3’ were used for the first PCR reaction, and primers 5’ -AATGATACGGCGACCACCGA-3’ and 5’ -CAAGCAGAAGACGGCATACGA-3’ were used for the second PCR reaction. In the first PCR reaction, the pooled cDNA samples were amplified for 15 cycles in 250 ul of reaction volume per 7-8 samples. After treatment with Exonuclease I (New England Biolabs, M0293S) to remove excess primers, all the PCR1 products of the target areas were pooled together. A quarter of the pooled PCR1 products of target areas were amplified by 10 cycles in 12 ml of PCR II reaction volume. The PCR2 products were cleaned up and concentrated by SV wizard PCR cleanup kit (Promega, A9282), and loaded into a 2% agarose gel for electrophoresis. The 233 bp PCR product was cut from the agarose gel, cleaned up by Qiagen MinElute Gel Extraction Kit (Qiagen 28606) and quantified by Bioanalyzer (Agilent, 5067-4626) and qPCR.  Sequencing of the MAPseq samplesThe pooled library was sequenced on two lanes of Illumina Nextseq550 high output at paired end 36 with Illumina compatible Read 1 Sequencing Primer and Illumina compatible small RNA read 2 primer as described previously (Kebschull et al. 2016). MAPseq data processingThe raw MAPseq data consists of FASTQ files, where paired end 1 covers the 30 nt barcode sequence and paired end 2 covers 12 nt UMI and the 8 nt SSI (Huang et al. 2020; Kebschull et al. 2016). The raw sequencing data is processed via an integrated pipeline written in Python, using Pandas, Numpy, and NetworkX libraries. Code and documentation are available at: https://github.com/ZadorLaboratory/mapseq-processing We first assemble the reads from the paired-end input, trimming each to the length of the sequence of interest. These sequences are then aggregated by exact duplicate and the read count for each unique sequence kept. We remove any data with ambiguous bases or long runs (>7) of the same base. We label and categorize all the reads by SSI sequence and expected spike-in sub-sequence. In order to account for expected replication, amplification, and sequencing errors, we identify all barcodes that differ from each other by an edit distance of 3 or less. This parameter is informed by the barcode sequence length, and the known diversity of the virus library. All groups of barcodes are then collapsed to the most common variant, as measured by read count.    We then aggregate by barcode, SSI, and UMI sequence, retaining the number of UMIs in each. To exclude low-confidence projections, we required a barcode to have at least 5 molecule counts in at least one projection region. We have also normalized the variation in library preparation and sequencing across different samples within each brain based on recovered spike-in RNA as described previously (Han et al. 2018; Kebschull et al. 2016).BARseq library preparationBARseq samples for in situ sequencing were prepared using the following protocol (dx.doi.org/10.17504/protocols.io.n2bvj82q5gk5/v1), as described previously (Chen et al. 2019; Sun et al. 2021; Chen et al. 2022).Briefly, brain sections were fixed in 4% paraformaldehyde in PBS for 1 hr, dehydrated through 70%, 85%, and 100% ethanol, and incubated in 100% ethanol for 1.5 hr at 4 °C. After rehydration in PBST (PBS and 0.5% Tween-20), slices were incubated in the reverse transcription mix (RT primers, 20 U/?L RevertAid H Minus M-MuLV reverse transcriptase, 500 ?M dNTP, 0.2 ?g/?L BSA, 1 U/?L RiboLock RNase Inhibitor, 1?RevertAid RT buffer) at 37 °C overnight. On day two, cDNA was cross-linked using BS(PEG)9 (40 ?L in 160 ?L PBST) for 1 hr, the remaining crosslinker neutralized with 1 M Tris pH 8.0 for 30 min, followed by a wash with PBST. Sections were then incubated with non-gap-filling ligation mix (1?Ampligase buffer, padlock probe mix for endogenous genes, 0.5 U/?L Ampligase, 0.4 U/?L RNase H, 1 U/?L RiboLock RNase Inhibitor, additional 50 mM KCl, 20% formamide) for 30 min at 37 °C and 45 min at 45 °C. Then sections were incubated in gap-filling ligation mix (same as the non-gap-filling mix with the Sindbis barcode padlock probe [XCAI5] as the only padlock probe, and with 50 ?M dNTP, 0.2 U/?L Phusion DNA polymerase, and 5% glycerol) for 5 min at 37 °C and 45 min at 45 °C. After the second round of ligation, samples were washed with PBST, hybridized with 1 ?M RCA primer (XC1417) for 10 mins in 2?SSC with10% formamide, followed by two washes in 2?SSC with10% formamide and twice in PBST, then incubated in the RCA mix (1 U/?L phi29 DNA polymerase, 1 x phi29 polymerase buffer, 0.25 mM dNTP, 0.2 ?g/?L BSA, 5% glycerol (extra of those from the enzymes), 125 ?M aminoallyl dUTP) overnight at room temperature to complete rolling circle amplification. On day three, rolonies were crosslinked using BS(PEG)9 (40 ?L in 160 ?L PBST) for 1 hr, the remaining crosslinker neutralized with 1 M Tris pH 8.0 for 30 min, followed by a wash with PBST.BARseq sequencing and imagingSequencing was performed using Illumina MiSeq Reagent Nano Kit v2 (300-cycles) and imaged on a Nikon Ti2-E microscope with Crest xlight v3 spinning disk confocal, photometrics Kinetix camera, and Lumencor Celesta laser. All images were taken with a Nikon CFI S Plan Fluor LWD 20X 0.7NA non-immersion objective. For each sample, first seven sequencing cycles probe the selected gene panel, followed by 15 sequencing cycles for barcodes, followed by hybridization cycle. In each imaging round, a z-stack of 10 images centered around the region of interest was captured with a 1.5 ?m step size at each field of view (FOV). Adjacent FOVs had an overlap of 24%. Detailed protocol is available here (dx.doi.org/10.17504/protocols.io.81wgbp4j3vpk/v2). Briefly, for sequencing the first gene cycles, the sequencing primer (YS220) was hybridized in 2?SSC with 10% formamide for 10 minutes at room temperature. Subsequently, the sample underwent two washes in 2?SSC with 10% formamide and twice in PBS2T (PBS with 2% Tween-20). Following this, the sample was incubated in MiSeq Incorporation buffer at 60 °C for 3 minutes, followed by a wash in PBS2T. The sample was then exposed to Iodoacetamide (9.3 mg vial in 2.5 mL PBS2T) at 60 °C for 3 minutes, followed by a single wash in PBS2T and twice in Incorporation buffer. It was then subjected to two incubations in IMS at 60 °C for 3 minutes, followed by four washes with PBS2T at 60 °C for 3 minutes. Finally, the sample was washed and imaged in SRE.For sequencing the first barcode cycle, the sequenced products were initially stripped with three 10-minute incubations at 60 °C in 2?SSC with 60% formamide. Subsequently, the sample was washed with 2?SSC with 10% formamide, and the barcode sequencing primer (XCAI5) was hybridized. The sequencing process then proceeded similarly to the first gene cycle.For subsequent sequencing cycles for both genes and barcodes, the sample underwent two washes in Incorporation buffer, followed by two incubations in CMS at 60 °C for 3 minutes. This was succeeded by two more washes in Incorporation buffer, after which the sample was treated with iodoacetamide as in the first sequencing cycle.During hybridization cycles, the sequenced products were stripped with three 10-minute incubations at 60 °C in 2?SSC with 60% formamide. The sample was then washed with 2?SSC with 10% formamide. Following this, the hybridization probes (XC2758, XC2759, XC2760, YS221) were hybridized for 10 minutes at room temperature. The sample was subsequently washed twice with 2?SSC with 10% formamide and incubated in PBST with 0.002 mg/mL DAPI for 5 minutes. Finally, the sample was transferred to SRE for imaging.For brain #1 all the above steps were completed manually. For the subsequent samples in situ sequencing was performed on an automated microfluidics set up mounted on the microscope using the same reagents, temperatures and incubation durations. BARseq data processingBARseq data were processed according to previous methods (Sun et al. 2021) with slight adjustments. Max-projections were generated from the image stacks, followed by noise reduction using Noise2Void (Krull et al. 2018). Subsequently, background subtraction, correction for channel shift and bleed-through, and registration of images across all sequencing cycles were applied. Cell segmentation was performed using Cellpose (Stringer et al. 2021), while rolonies were decoded using BarDensr (Chen et al. 2021), and then assigned to cells.During BarDensr decoding, negative control GIIs (GIIs not associated with any padlock probe) were utilized to estimate the false discovery rate (FDR), with the decoding threshold automatically adjusted to target approximately 5% FDR. Whole-slice images were generated by stitching individual imaging fields of view (FOV). Processing steps were applied separately to each FOV to prevent stitching errors, minimize alignment artifacts, and facilitate parallel processing. Stitched images were solely used to generate a transformation, applied to each rolony and cell after completing all other steps.Overlapping cells from neighboring FOVs were identified using a custom implementation of sort and sweep collision detection algorithm (Baraff and Witkin 1992). In cases where two or more cells overlapped, cells with higher read counts (indicating higher read quality) were retained.Each stitched slice was registered to Allen CCFv3 using manual registration. QuickNii (v.3 2017) was used to manually select the CCF plane for each slice, followed by alignment of area borders within each slice using Visualign (v. 0.9) using nonlinear adjustments to the coronal plates. 